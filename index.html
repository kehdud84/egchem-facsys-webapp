<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EGChem FACSYS 점검 시스템</title>
    
    <!-- PWA 설정 -->
    <meta name="theme-color" content="#2b2b2b">
    <meta name="description" content="EGChem FACSYS 설비 및 장비 점검 관리 시스템">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="EGChem FACSYS">
    
    <!-- PWA 아이콘 -->
    <link rel="icon" type="image/png" href="icons/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="icons/favicon-16x16.png" sizes="16x16">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
    
    <!-- PWA 매니페스트 -->
    <link rel="manifest" href="manifest.json">
    
    <!-- CSS -->
    <link rel="stylesheet" href="styles/main.css">
    
    <!-- Google Sheets API -->
    <script src="https://apis.google.com/js/api.js"></script>
    
    <!-- 오프라인 지원을 위한 Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</head>
<body>
    <div id="app">
        <!-- 로딩 화면 -->
        <div id="loading" class="loading-screen">
            <div class="loading-spinner"></div>
            <p>EGChem FACSYS 점검 시스템 로딩 중...</p>
        </div>
        
        <!-- 메인 앱 -->
        <div id="main-app" class="main-app" style="display: none;">
            <!-- 메인 화면 (기존 프로그램과 동일) -->
            <div id="main-screen" class="main-screen">
                <div class="main-container">
                    <!-- EGChem 로고 -->
                    <div class="logo-container">
                        <img src="EGChem 로고.png" alt="EGChem Logo" class="company-logo">
                    </div>
                    <h1>FACSYS<br>설비 및 장비 점검 시스템</h1>
                    
                    <!-- 팀 버튼 (기존 프로그램과 동일) -->
                    <div class="main-button-container">
                        <button id="main-button" class="main-button" onclick="openEquipmentCheck()">
                            제조파트
                        </button>
                    </div>
                    
                    <!-- 연결 설정 버튼 -->
                    <div class="settings-container">
                        <div class="connection-status-display">
                            <span id="main-connection-status" class="status-indicator">연결 확인 중...</span>
                        </div>
                        <button class="btn-secondary" onclick="openConnectionSettings()">연결 설정</button>
                    </div>
                    
                    <!-- 오프라인 상태 표시 -->
                    <div id="offline-indicator" class="offline-indicator" style="display: none;">
                        <span>📱 오프라인 모드 - 데이터는 로컬에 저장됩니다</span>
                    </div>
                </div>
            </div>
            
            <!-- 점검 화면 (1-A 버튼 클릭 시 표시) - 기존 프로그램과 동일한 구조 -->
            <div id="equipment-check-screen" class="equipment-check-screen" style="display: none;">
                <!-- 상단 프레임 (되돌아가기 버튼 + 사용자 정보) -->
                <div class="top-frame">
                    <button class="back-button" onclick="goBackToMain()">← 메인 화면</button>
                    <div class="user-info">
                        <span id="user-name">1-A 팀</span>
                    </div>
                </div>
                
                <!-- 메인 콘텐츠 (왼쪽 사이드바 + 오른쪽 메인) -->
                <div class="main-layout">
                    <!-- 사이드바 토글 버튼 (모바일용) -->
                    <button class="sidebar-toggle" onclick="toggleSidebar()">☰</button>
                    
                    <!-- 왼쪽 사이드바 (기존 프로그램과 동일) -->
                    <div class="sidebar" id="sidebar">
                        <!-- 점검 유형 선택 -->
                        <div class="inspection-types-section">
                            <h3>점검 유형</h3>
                        <div class="type-buttons">
                            <button class="type-btn" data-type="일일점검">일일점검</button>
                            <button class="type-btn" data-type="주간점검">주간점검</button>
                            <button class="type-btn" data-type="월간점검">월간점검</button>
                            <button class="type-btn" data-type="분기점검">분기점검</button>
                            <button class="type-btn" data-type="반기점검">반기점검</button>
                            <button class="type-btn" data-type="연간점검">연간점검</button>
                        </div>
                    </div>
                    
                        <!-- 장비 목록 -->
                        <div class="equipment-section">
                        <h3>장비 목록</h3>
                        <div id="equipment-items" class="equipment-items"></div>
                        </div>
                    </div>
                    
                    <!-- 오른쪽 메인 콘텐츠 (기존 프로그램과 동일한 단계별 진행) -->
                    <div class="main-content">
                        <!-- 단계 1: 점검자 이름 입력 -->
                        <div id="step-inspector" class="inspection-step" style="display: none;">
                            <h2>점검자 이름 입력</h2>
                            <div class="form-group">
                                <label>점검자:</label>
                                <input type="text" id="inspector-name" required placeholder="점검자 이름을 입력하세요">
                            </div>
                            <button type="button" class="btn-primary" onclick="nextStep('location')">다음</button>
                        </div>
                        
                        <!-- 단계 2: 설치위치 선택 -->
                        <div id="step-location" class="inspection-step" style="display: none;">
                            <h2>설치위치 선택</h2>
                            <div class="location-buttons">
                                <button class="location-btn" data-location="3동" onclick="selectLocation('3동')">3동</button>
                                <button class="location-btn" data-location="정제실1" onclick="selectLocation('정제실1')">정제실1</button>
                                <button class="location-btn" data-location="정제실2" onclick="selectLocation('정제실2')">정제실2</button>
                                <button class="location-btn" data-location="창고" onclick="selectLocation('창고')">창고</button>
                                <button class="location-btn" data-location="기타" onclick="selectLocation('기타')">기타</button>
                            </div>
                            <button type="button" class="btn-secondary" onclick="prevStep('inspector')">이전</button>
                        </div>
                        
                        <!-- 단계 3: 점검 내용 선택 -->
                        <div id="step-inspection" class="inspection-step" style="display: none;">
                            <h2>점검 내용 선택</h2>
                            <div id="check-items" class="check-items"></div>
                            <div class="step-buttons">
                                <button type="button" class="btn-secondary" onclick="prevStep('location')">이전</button>
                                <button type="button" class="btn-primary" onclick="nextStep('notes')">다음</button>
                    </div>
                </div>
                
                        <!-- 단계 4: 특이사항 입력 및 완료 -->
                        <div id="step-notes" class="inspection-step" style="display: none;">
                            <h2>특이사항 입력</h2>
                            <div class="form-group">
                                <label>특이사항:</label>
                                <textarea id="notes" rows="3" placeholder="특이사항을 입력하세요 (선택사항)"></textarea>
                </div>
                            <div class="step-buttons">
                                <button type="button" class="btn-secondary" onclick="prevStep('inspection')">이전</button>
                                <button type="button" class="btn-primary" onclick="submitInspection()">점검 완료</button>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 연결 설정 모달 (기존 프로그램과 동일) -->
        <div id="connection-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>🔧 구글 시트 연결 설정</h2>
                    <button class="close-btn" onclick="closeConnectionSettings()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Google Apps Script 웹앱 URL:</label>
                        <input type="text" id="webapp-url" placeholder="https://script.google.com/macros/s/.../exec">
                        <small style="color: #ccc; font-size: 0.8rem;">Google Apps Script에서 배포한 웹앱 URL을 입력하세요</small>
                    </div>
                    <div class="form-group">
                        <label>스프레드시트 ID:</label>
                        <input type="text" id="spreadsheet-id" value="1QjU-kQDRgDrZ5tUn6awJhRWWx9u0Mt4uLCFmkOqLNcQ" readonly>
                    </div>
                    <div class="form-group">
                        <label>연결 상태:</label>
                        <span id="connection-status" class="status-indicator">연결 확인 중...</span>
                    </div>
                    
                    <!-- 오프라인 모드 안내 -->
                    <div class="offline-info">
                        <h4>📱 오프라인 모드</h4>
                        <p>인터넷 연결이 없어도 점검 데이터를 입력할 수 있습니다. 연결이 복구되면 자동으로 구글 시트에 동기화됩니다.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeConnectionSettings()">취소</button>
                    <button class="btn-primary" onclick="testConnection()">연결 테스트</button>
                    <button class="btn-primary" onclick="saveConnectionSettings()">저장</button>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- JavaScript -->
    <script src="js/googleSheetsJSONP.js"></script>
    <script src="js/app.js"></script>
    <script src="js/inspection.js"></script>
    
    <script>
        // 오프라인 상태 감지
        function updateOnlineStatus() {
            const offlineIndicator = document.getElementById('offline-indicator');
            if (navigator.onLine) {
                offlineIndicator.style.display = 'none';
            } else {
                offlineIndicator.style.display = 'block';
            }
        }
        
        // 페이지 로드 시 오프라인 상태 확인
        window.addEventListener('load', updateOnlineStatus);
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        // 연결 설정 모달 열기 (기존 프로그램과 동일)
        function openConnectionSettings() {
            document.getElementById('connection-modal').style.display = 'flex';
            updateConnectionStatus();
            
            // 저장된 웹앱 URL이 있으면 입력 필드에 표시
            const savedUrl = localStorage.getItem('google_webapp_url');
            if (savedUrl) {
                document.getElementById('webapp-url').value = savedUrl;
            }
        }
        
        // 페이지 로드 시 자동 연결 상태 확인
        window.addEventListener('load', function() {
            setTimeout(() => {
                updateConnectionStatus();
            }, 1000); // 1초 후 연결 상태 확인 (자동 연결 완료 대기)
        });
        
        // 연결 설정 모달 닫기
        function closeConnectionSettings() {
            document.getElementById('connection-modal').style.display = 'none';
        }
        
        // 연결 상태 업데이트
        function updateConnectionStatus() {
            // 메인 화면 연결 상태 업데이트
            const mainStatusElement = document.getElementById('main-connection-status');
            if (mainStatusElement) {
                if (window.googleSheetsManager && window.googleSheetsManager.isConnected) {
                    mainStatusElement.textContent = '✅ 연결됨';
                    mainStatusElement.className = 'status-indicator connected';
                } else {
                    mainStatusElement.textContent = '❌ 연결 안됨';
                    mainStatusElement.className = 'status-indicator disconnected';
                }
            }
            
            // 연결 설정 모달의 연결 상태 업데이트 (모달이 열려있다면)
            const modalStatusElement = document.getElementById('connection-status');
            if (modalStatusElement) {
                if (window.googleSheetsManager && window.googleSheetsManager.isConnected) {
                    modalStatusElement.textContent = '연결됨';
                    modalStatusElement.className = 'status-indicator connected';
                } else {
                    modalStatusElement.textContent = '연결 안됨';
                    modalStatusElement.className = 'status-indicator disconnected';
                }
            }
        }
        
        // 연결 테스트
        async function testConnection() {
            const statusElement = document.getElementById('connection-status');
            const webappUrl = document.getElementById('webapp-url').value.trim();
            
            if (!webappUrl) {
                alert('Google Apps Script 웹앱 URL을 입력해주세요.');
                return;
            }
            
            statusElement.textContent = '테스트 중...';
            statusElement.className = 'status-indicator checking';
            
            try {
                if (window.googleSheetsManager) {
                    // 웹앱 URL 설정
                    window.googleSheetsManager.setWebAppUrl(webappUrl);
                    
                    const success = await window.googleSheetsManager.testConnection();
                    if (success) {
                        statusElement.textContent = '연결 성공';
                        statusElement.className = 'status-indicator connected';
                        alert('구글 시트 연결이 성공했습니다!');
                    } else {
                        statusElement.textContent = '연결 실패';
                        statusElement.className = 'status-indicator disconnected';
                        alert('구글 시트 연결에 실패했습니다. 웹앱 URL을 확인해주세요.');
                    }
                } else {
                    throw new Error('구글 시트 매니저가 초기화되지 않았습니다.');
                }
            } catch (error) {
                console.error('연결 테스트 실패:', error);
                statusElement.textContent = '연결 실패';
                statusElement.className = 'status-indicator disconnected';
                alert('연결 테스트 중 오류가 발생했습니다: ' + error.message);
            }
        }
        
        // 연결 설정 저장
        function saveConnectionSettings() {
            const webappUrl = document.getElementById('webapp-url').value.trim();
            
            if (!webappUrl) {
                alert('Google Apps Script 웹앱 URL을 입력해주세요.');
                return;
            }
            
            if (window.googleSheetsManager) {
                window.googleSheetsManager.setWebAppUrl(webappUrl);
                localStorage.setItem('google_webapp_url', webappUrl);
                closeConnectionSettings();
                alert('연결 설정이 저장되었습니다.');
            } else {
                alert('구글 시트 매니저가 초기화되지 않았습니다.');
            }
        }
        
        // 전역 함수들 (HTML에서 직접 호출)
        function nextStep(stepName) {
            if (window.app) {
                window.app.nextStep(stepName);
            } else {
                console.error('app 객체가 초기화되지 않았습니다.');
            }
        }
        
        function prevStep(stepName) {
            if (window.app) {
                window.app.prevStep(stepName);
            } else {
                console.error('app 객체가 초기화되지 않았습니다.');
            }
        }
        
        function selectLocation(location) {
            if (window.app) {
                window.app.selectLocation(location);
            } else {
                console.error('app 객체가 초기화되지 않았습니다.');
            }
        }
        
        function submitInspection() {
            if (window.app) {
                window.app.submitInspection();
            } else {
                console.error('app 객체가 초기화되지 않았습니다.');
            }
        }
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.classList.toggle('hidden');
                console.log('사이드바 토글:', sidebar.classList.contains('hidden') ? '숨김' : '표시');
            }
        }
        
        function openEquipmentCheck() {
            if (window.app) {
                window.app.openEquipmentCheck();
            } else {
                console.error('app 객체가 초기화되지 않았습니다.');
            }
        }
        
        function goBackToMain() {
            if (window.app) {
                window.app.goBackToMain();
            } else {
                console.error('app 객체가 초기화되지 않았습니다.');
            }
        }
    </script>
</body>
</html>
